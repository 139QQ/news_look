# NewsLook 爬虫架构升级计划

## 背景

目前项目中存在多个爬虫架构（BaseCrawler、UnifiedCrawler、OptimizedCrawler等），导致代码重复、维护困难且不易扩展。项目已初步引入了基于策略模式的统一爬虫架构，但尚未全面应用。

## 升级目标

1. 统一使用 `app/crawlers/core/base_crawler.py` 作为爬虫基础架构
2. 将所有网站特定爬取逻辑迁移到对应的策略类中
3. 支持同步和异步爬取模式，提高爬取效率
4. 改进数据处理和存储流程，支持批量操作
5. 降低代码耦合度，提高可维护性和可扩展性

## 核心组件

1. **BaseCrawler** - 统一的爬虫基类，实现通用爬取流程
2. **BaseCrawlerStrategy** - 策略接口，定义特定网站爬取规则
3. **DataProcessor** - 数据处理组件，负责数据清洗和存储
4. **HttpClient** - HTTP请求组件，支持同步和异步请求

## 迁移路线图

### 阶段1: 基础架构完善 (1周)

1. 完善核心组件的实现
   - 确保BaseCrawler同步/异步功能正常工作
   - 完善HttpClient的错误处理和重试机制
   - 优化DataProcessor批量存储和事务管理

2. 建立迁移测试框架
   - 创建测试用例验证核心功能
   - 建立爬虫性能基准测试

### 阶段2: 策略类实现 (2周)

1. 完善现有策略类实现
   - 细化每个网站的解析规则
   - 添加更多特定网站的辅助方法

2. 实现所有支持站点的策略类
   - 东方财富策略类
   - 新浪财经策略类
   - 网易财经策略类
   - 凤凰财经策略类

### 阶段3: 爬虫类迁移 (2周)

1. 创建基于新架构的爬虫实现
   - 创建新爬虫类继承自BaseCrawler
   - 依次迁移每个爬虫的特殊功能

2. 编写适配器连接新旧接口
   - 确保旧接口调用能正确转发到新实现
   - 保证向后兼容性

### 阶段4: 管理接口更新 (1周)

1. 更新CrawlerManager接口
   - 支持新的爬虫架构
   - 保留向后兼容性

2. 更新命令行接口
   - 支持新的爬虫参数
   - 添加异步模式控制选项

### 阶段5: 验证与优化 (1周)

1. 全站点验证测试
   - 确保所有网站爬取功能正常
   - 对比新旧架构性能差异

2. 性能优化
   - 基于测试结果进行优化
   - 调整并发参数和批处理大小

## 迁移细节

### 东方财富爬虫迁移

1. 基于`EastMoneyStrategy`实现爬取规则
2. 创建`EastMoneyCrawler`类继承自`BaseCrawler`
3. 迁移特殊功能（如图片处理、广告过滤等）

### 新浪财经爬虫迁移

1. 基于`SinaStrategy`实现爬取规则
2. 创建`SinaCrawler`类继承自`BaseCrawler`
3. 迁移编码处理和特殊页面解析逻辑

### 网易财经爬虫迁移

1. 基于`NeteaseStrategy`实现爬取规则
2. 创建`NeteaseCrawler`类继承自`BaseCrawler`
3. 迁移广告过滤和图片检测功能

### 凤凰财经爬虫迁移

1. 基于`IfengStrategy`实现爬取规则
2. 创建`IfengCrawler`类继承自`BaseCrawler`
3. 迁移特殊内容处理逻辑

## 风险与对策

1. **兼容性问题**
   - 风险：新架构可能与现有代码不兼容
   - 对策：创建适配层维持旧接口，逐步迁移调用代码

2. **性能退化**
   - 风险：架构变更可能导致性能下降
   - 对策：建立性能基准，确保新架构至少与旧架构性能相当

3. **爬取效果变化**
   - 风险：网站解析规则变更可能导致爬取结果不一致
   - 对策：建立数据质量测试，确保迁移前后结果一致

## 预期收益

1. 代码复用度提高，减少重复代码约50%
2. 异步爬取模式预计提升性能30%-50%
3. 新网站接入时间缩短75%，只需实现策略类
4. 维护成本大幅降低，架构更清晰可扩展 