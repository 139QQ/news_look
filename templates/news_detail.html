{% extends 'base.html' %}

{% block title %}{{ news.title }} - NewsLook{% endblock %}

{% block head %}
<!-- 添加新的文章样式表 -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/article.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
  <div class="row">
    <div class="col-lg-9 mx-auto">
      <div class="news-container">
        <!-- 标题区域 -->
        <h1 class="news-title">{{ news.title }}</h1>
        
        <!-- 元数据区域 -->
        <div class="news-meta">
          <div class="news-source">
            <i class="bi bi-globe"></i>
            {{ news.source }}
          </div>
          
          <div class="news-time">
            <i class="bi bi-clock"></i>
            {{ news.pub_time }}
          </div>
          
          {% if news.author %}
          <div class="news-author">
            <i class="bi bi-person"></i>
            {{ news.author }}
          </div>
          {% endif %}
          
          {% if news.category %}
          <div>
            <span class="news-category">{{ news.category }}</span>
          </div>
          {% endif %}
          
          <!-- 情感分析标签 -->
          {% if news.sentiment is defined and news.sentiment is not none %}
            {% set sentiment = news.sentiment|float %}
            {% if sentiment > 0.6 %}
              <span class="sentiment-badge sentiment-positive">
                <i class="bi bi-emoji-smile"></i> 积极
              </span>
            {% elif sentiment > 0.4 %}
              <span class="sentiment-badge sentiment-neutral">
                <i class="bi bi-emoji-neutral"></i> 中性
              </span>
            {% else %}
              <span class="sentiment-badge sentiment-negative">
                <i class="bi bi-emoji-frown"></i> 消极
              </span>
            {% endif %}
          {% endif %}
        </div>
        
        <!-- 内容区域 -->
        <div class="news-content">
          {{ news.content|safe }}
        </div>
        
        <!-- 关键词区域 -->
        {% if news.keywords %}
        <div class="news-keywords">
          <h5><i class="bi bi-tags"></i> 关键词</h5>
          <div class="keyword-tags">
            {% for keyword in news.keywords %}
            <a href="/?keyword={{ keyword }}" class="keyword-tag">{{ keyword }}</a>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <!-- 相关图片区域 -->
        {% if news.images %}
        <!-- 隐藏的图片数据 -->
        <script type="application/json" id="imagesData">
          [
            {% for image in news.images %}
            {
              "url": "{{ image.url|safe }}",
              "alt": "{{ image.alt|default('新闻图片')|safe }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          ]
        </script>
        
        <div class="news-images">
          <h5><i class="bi bi-images"></i> 相关图片 <span class="text-muted">({{ news.images|length }}张)</span></h5>
          <!-- 分页卡片式布局 -->
          <div class="image-gallery">
            <div class="row">
              {% for image in news.images[:9] %}
              <div class="col-md-4 col-sm-6 mb-3">
                <a href="{{ image.url }}" target="_blank" class="image-card">
                  <div class="card">
                    <img src="{{ image.url }}" class="card-img-top lazy-load" 
                         alt="{{ image.alt|default('新闻图片') }}" loading="lazy"
                         data-src="{{ image.url }}"
                         onerror="this.onerror=null; this.src='/static/img/image-error.jpg'; this.alt='图片加载失败';">
                    <div class="card-body p-2">
                      <p class="card-text small text-truncate">{{ image.alt|default('新闻图片') }}</p>
                    </div>
                  </div>
                </a>
              </div>
              {% endfor %}
            </div>
            
            {% if news.images|length > 9 %}
            <div class="text-center mt-2">
              <button class="btn btn-outline-primary btn-sm" id="loadMoreImages">
                加载更多图片 ({{ news.images|length - 9 }}张)
              </button>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        <!-- 相关新闻区域 -->
        {% if news.related %}
        <div class="related-news">
          <h5><i class="bi bi-link-45deg"></i> 相关新闻</h5>
          <ul class="related-news-list">
            {% for related in news.related %}
            <li class="related-news-item">
              <a href="/news/{{ related.id }}" class="related-news-link">
                <i class="bi bi-arrow-right-circle"></i>
                <span>{{ related.title }}</span>
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        <!-- 操作按钮区域 -->
        <div class="news-actions">
          <button class="action-btn btn-save {% if is_saved %}saved{% endif %}" 
                  onclick="toggleSaved('{{ user_id }}', '{{ news.id }}')">
            <i class="bi {% if is_saved %}bi-bookmark-fill{% else %}bi-bookmark{% endif %}"></i>
            <span class="btn-text">{% if is_saved %}已收藏{% else %}收藏{% endif %}</span>
          </button>
          
          <button class="action-btn btn-read {% if is_read %}read{% endif %}" 
                  onclick="toggleRead('{{ user_id }}', '{{ news.id }}')">
            <i class="bi {% if is_read %}bi-check-circle-fill{% else %}bi-check-circle{% endif %}"></i>
            <span class="btn-text">{% if is_read %}已读{% else %}标记为已读{% endif %}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // 收藏/取消收藏功能
  function toggleSaved(userId, newsId) {
    fetch('/api/user/toggle_saved', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_id: userId,
        news_id: newsId,
        saved: !document.querySelector('.btn-save').classList.contains('saved')
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const saveBtn = document.querySelector('.btn-save');
        const iconEl = saveBtn.querySelector('i');
        const textEl = saveBtn.querySelector('.btn-text');
        
        saveBtn.classList.toggle('saved');
        
        if (saveBtn.classList.contains('saved')) {
          iconEl.classList.remove('bi-bookmark');
          iconEl.classList.add('bi-bookmark-fill');
          textEl.textContent = '已收藏';
        } else {
          iconEl.classList.remove('bi-bookmark-fill');
          iconEl.classList.add('bi-bookmark');
          textEl.textContent = '收藏';
        }
      }
    })
    .catch(error => {
      console.error('请求失败:', error);
    });
  }
  
  // 标记为已读/未读功能
  function toggleRead(userId, newsId) {
    fetch('/api/user/toggle_read', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_id: userId,
        news_id: newsId,
        read: !document.querySelector('.btn-read').classList.contains('read')
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const readBtn = document.querySelector('.btn-read');
        const iconEl = readBtn.querySelector('i');
        const textEl = readBtn.querySelector('.btn-text');
        
        readBtn.classList.toggle('read');
        
        if (readBtn.classList.contains('read')) {
          iconEl.classList.remove('bi-check-circle');
          iconEl.classList.add('bi-check-circle-fill');
          textEl.textContent = '已读';
        } else {
          iconEl.classList.remove('bi-check-circle-fill');
          iconEl.classList.add('bi-check-circle');
          textEl.textContent = '标记为已读';
        }
      }
    })
    .catch(error => {
      console.error('请求失败:', error);
    });
  }
  
  // 页面加载完成后执行
  document.addEventListener('DOMContentLoaded', function() {
    // 初始化图片懒加载
    initLazyLoading();
    
    // 初始化加载更多按钮
    initLoadMoreImages();
    
    // 全局图片错误处理
    initImageErrorHandling();
  });
  
  // 初始化懒加载
  function initLazyLoading() {
    const lazyImages = document.querySelectorAll('.lazy-load');
    
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            const src = img.getAttribute('data-src');
            if (src) {
              img.src = src;
              img.classList.add('loaded');
              imageObserver.unobserve(img);
            }
          }
        });
      });
      
      lazyImages.forEach(img => imageObserver.observe(img));
    } else {
      // 降级处理：直接加载所有图片
      lazyImages.forEach(img => {
        img.src = img.getAttribute('data-src');
        img.classList.add('loaded');
      });
    }
  }
  
  // 初始化加载更多按钮
  function initLoadMoreImages() {
    const loadMoreBtn = document.getElementById('loadMoreImages');
    if (!loadMoreBtn) return;
    
    // 将所有图片数据存储在页面上的隐藏元素中
    const allImagesData = JSON.parse(document.getElementById('imagesData').textContent);
    
    loadMoreBtn.addEventListener('click', function() {
      // 获取当前显示的图片数量
      const imageContainer = document.querySelector('.image-gallery .row');
      const currentCount = imageContainer.querySelectorAll('.col-md-4').length;
      
      // 加载下一批图片（最多9张）
      const nextBatch = allImagesData.slice(currentCount, currentCount + 9);
      if (nextBatch.length === 0) return;
      
      // 构建HTML
      let newHTML = '';
      for (const image of nextBatch) {
        newHTML += `
          <div class="col-md-4 col-sm-6 mb-3">
            <a href="${image.url}" target="_blank" class="image-card">
              <div class="card">
                <img src="/static/img/image-error.jpg" class="card-img-top lazy-load" 
                     alt="${image.alt}" loading="lazy"
                     data-src="${image.url}"
                     onerror="this.onerror=null; this.src='/static/img/image-error.jpg'; this.alt='图片加载失败';">
                <div class="card-body p-2">
                  <p class="card-text small text-truncate">${image.alt}</p>
                </div>
              </div>
            </a>
          </div>
        `;
      }
      
      // 添加到DOM
      imageContainer.insertAdjacentHTML('beforeend', newHTML);
      
      // 为新添加的图片初始化懒加载
      initLazyLoading();
      
      // 更新或隐藏按钮
      const remainingCount = allImagesData.length - (currentCount + nextBatch.length);
      if (remainingCount > 0) {
        loadMoreBtn.textContent = `加载更多图片 (${remainingCount}张)`;
      } else {
        loadMoreBtn.style.display = 'none';
      }
    });
  }
  
  // 初始化图片错误处理
  function initImageErrorHandling() {
    const allImages = document.querySelectorAll('img');
    
    allImages.forEach(img => {
      if (!img.hasAttribute('onerror')) {
        img.setAttribute('data-original-src', img.src);
        img.onerror = function() {
          this.onerror = null;
          this.src = '/static/img/image-error.jpg';
          this.alt = '图片加载失败';
          console.log('图片加载失败: ' + this.getAttribute('data-original-src'));
        };
      }
    });
  }
</script>
{% endblock %}