{% extends 'base.html' %}

{% block title %}财经新闻爬虫系统 - 首页{% endblock %}

{% block content %}
<!-- 左侧筛选区域 -->
<aside class="filter-section" aria-label="筛选选项">
    <div class="filter-toggle" tabindex="0" role="button" aria-expanded="false" aria-controls="filter-content">
        <i class="icon-filter"></i> 筛选条件 <i class="icon-arrow-down"></i>
    </div>
    <div id="filter-content" class="filter-content">
        <form action="{{ url_for('index') }}" method="get" aria-label="新闻搜索和筛选">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <i class="icon-search search-icon" aria-hidden="true"></i>
                    <input type="text" class="search-input" id="keyword" name="keyword" value="{{ keyword }}" placeholder="输入关键词，例：股票代码、行业名称" aria-label="搜索关键词">
                    <button type="submit" class="search-button">搜索</button>
                </div>
            </div>
            
            <div class="filter-group time-filter">
                <h3 class="filter-group-title" id="time-range-heading"><i class="icon-calendar" aria-hidden="true"></i> 时间范围</h3>
                <div class="filter-options time-options" role="group" aria-labelledby="time-range-heading">
                    <a href="{{ url_for('index', days=1, source=source, sentiment=sentiment, view=view_mode) }}" class="filter-option {% if days == 1 %}active{% endif %}" role="button" aria-pressed="{% if days == 1 %}true{% else %}false{% endif %}">今天</a>
                    <a href="{{ url_for('index', days=3, source=source, sentiment=sentiment, view=view_mode) }}" class="filter-option {% if days == 3 %}active{% endif %}" role="button" aria-pressed="{% if days == 3 %}true{% else %}false{% endif %}">最近3天</a>
                    <a href="{{ url_for('index', days=7, source=source, sentiment=sentiment, view=view_mode) }}" class="filter-option {% if days == 7 %}active{% endif %}" role="button" aria-pressed="{% if days == 7 %}true{% else %}false{% endif %}">最近7天</a>
                    <a href="{{ url_for('index', days=30, source=source, sentiment=sentiment, view=view_mode) }}" class="filter-option {% if days == 30 %}active{% endif %}" role="button" aria-pressed="{% if days == 30 %}true{% else %}false{% endif %}">最近30天</a>
                </div>
            </div>
            
            <div class="filter-group source-filter">
                <h3 class="filter-group-title" id="source-heading"><i class="icon-source" aria-hidden="true"></i> 新闻来源</h3>
                <div class="filter-options" role="group" aria-labelledby="source-heading">
                    <a href="{{ url_for('index', days=days, sentiment=sentiment, view=view_mode) }}" class="filter-option {% if not source %}active{% endif %}" role="button" aria-pressed="{% if not source %}true{% else %}false{% endif %}">全部来源</a>
                    {% for src in sources %}
                    <a href="{{ url_for('index', days=days, source=src, sentiment=sentiment, view=view_mode) }}" class="filter-option {% if source == src %}active{% endif %}" role="button" aria-pressed="{% if source == src %}true{% else %}false{% endif %}">{{ src }}</a>
                    {% endfor %}
                </div>
            </div>
            
            <div class="filter-group sentiment-filter">
                <h3 class="filter-group-title" id="sentiment-heading"><i class="icon-sentiment" aria-hidden="true"></i> 情感倾向</h3>
                <div class="filter-options" role="group" aria-labelledby="sentiment-heading">
                    <a href="{{ url_for('index', days=days, source=source, view=view_mode) }}" class="filter-option {% if not sentiment %}active{% endif %}" role="button" aria-pressed="{% if not sentiment %}true{% else %}false{% endif %}">全部</a>
                    <a href="{{ url_for('index', days=days, source=source, sentiment='positive', view=view_mode) }}" class="filter-option {% if sentiment == 'positive' %}active{% endif %}" role="button" aria-pressed="{% if sentiment == 'positive' %}true{% else %}false{% endif %}">积极</a>
                    <a href="{{ url_for('index', days=days, source=source, sentiment='neutral', view=view_mode) }}" class="filter-option {% if sentiment == 'neutral' %}active{% endif %}" role="button" aria-pressed="{% if sentiment == 'neutral' %}true{% else %}false{% endif %}">中性</a>
                    <a href="{{ url_for('index', days=days, source=source, sentiment='negative', view=view_mode) }}" class="filter-option {% if sentiment == 'negative' %}active{% endif %}" role="button" aria-pressed="{% if sentiment == 'negative' %}true{% else %}false{% endif %}">消极</a>
                </div>
            </div>
        </form>
    </div>
</aside>

<!-- 中间新闻列表 -->
<section class="news-section" aria-label="新闻列表">
    <div class="news-header">
        <h2 class="section-title" id="news-heading">财经新闻</h2>
        <div class="news-actions">
            <div class="view-toggle">
                <a href="{{ url_for('index', view='list', keyword=keyword, days=days, source=source, sentiment=sentiment) }}" class="view-option {% if view_mode == 'list' %}active{% endif %}" title="列表视图" aria-label="列表视图" {% if view_mode == 'list' %}aria-current="page"{% endif %}>
                    <i class="icon-list" aria-hidden="true"></i>
                </a>
                <a href="{{ url_for('index', view='card', keyword=keyword, days=days, source=source, sentiment=sentiment) }}" class="view-option {% if view_mode == 'card' %}active{% endif %}" title="卡片视图" aria-label="卡片视图" {% if view_mode == 'card' %}aria-current="page"{% endif %}>
                    <i class="icon-grid" aria-hidden="true"></i>
                </a>
            </div>
            <div class="news-count" aria-live="polite">共 <strong>{{ total }}</strong> 条新闻</div>
        </div>
    </div>
    
    {% if news and view_mode == 'list' %}
    <div class="news-list" aria-labelledby="news-heading">
        {% for item in news %}
        <article class="news-card {% if item.sentiment > 0.2 %}sentiment-positive{% elif item.sentiment < -0.2 %}sentiment-negative{% else %}sentiment-neutral{% endif %}">
            <h3 class="news-title">
                <a href="{{ url_for('news_detail', news_id=item.id) }}">{{ item.title }}</a>
            </h3>
            <div class="news-meta">
                <span class="news-source"><i class="icon-source" aria-hidden="true"></i> {{ item.source }}</span>
                <span class="news-time"><i class="icon-time" aria-hidden="true"></i> {{ item.pub_time|default('未知时间', true) }}</span>
                {% if item.author and item.author != "未知作者" %}
                <span class="news-author"><i class="icon-user" aria-hidden="true"></i> {{ item.author }}</span>
                {% endif %}
                <span class="sentiment-indicator 
                    {% if item.sentiment > 0.2 %}sentiment-positive
                    {% elif item.sentiment < -0.2 %}sentiment-negative
                    {% else %}sentiment-neutral{% endif %}" 
                    title="情感值: {{ "%.2f"|format(item.sentiment) }}，{% if item.sentiment > 0.2 %}积极{% elif item.sentiment < -0.2 %}消极{% else %}中性{% endif %}"
                    aria-label="情感值: {{ "%.2f"|format(item.sentiment) }}，{% if item.sentiment > 0.2 %}积极{% elif item.sentiment < -0.2 %}消极{% else %}中性{% endif %}">
                </span>
            </div>
            <p class="news-summary">
                {{ item.content|default('暂无内容摘要', true)|truncate(200) }}
            </p>
            {% if item.keywords %}
            <div class="news-keywords" aria-label="关键词">
                {% for keyword in item.keywords.split(',')[:5] %}
                <a href="{{ url_for('index', keyword=keyword.strip(), view=view_mode) }}" class="keyword-tag">{{ keyword.strip() }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </article>
        {% endfor %}
    </div>
    {% elif categorized_news and view_mode == 'card' %}
    <div class="category-cards" aria-labelledby="news-heading">
        {% for source, items in categorized_news.items() %}
        <div class="category-card">
            <div class="category-card-header">
                <h3 class="category-card-title">{{ source }}</h3>
                <span class="category-card-count">{{ items|length }}条</span>
            </div>
            <div class="category-card-content">
                {% for item in items %}
                <div class="category-news-item">
                    <div class="category-news-title">
                        <a href="{{ url_for('news_detail', news_id=item.id) }}">{{ item.title }}</a>
                    </div>
                    <div class="category-news-meta">
                        <span class="news-time"><i class="icon-time" aria-hidden="true"></i> {{ item.pub_time|default('未知时间', true) }}</span>
                        <span class="sentiment-indicator 
                            {% if item.sentiment > 0.2 %}sentiment-positive
                            {% elif item.sentiment < -0.2 %}sentiment-negative
                            {% else %}sentiment-neutral{% endif %}" 
                            title="情感值: {{ "%.2f"|format(item.sentiment) }}，{% if item.sentiment > 0.2 %}积极{% elif item.sentiment < -0.2 %}消极{% else %}中性{% endif %}">
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="category-card-footer">
                <a href="{{ url_for('index', source=source, view=view_mode) }}" class="category-card-more">
                    查看更多 <i class="icon-arrow-right" aria-hidden="true"></i>
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state" aria-live="polite">
        <div class="empty-state-icon"><i class="icon-search" aria-hidden="true"></i></div>
        <p class="empty-state-message">没有找到符合条件的新闻</p>
        <p class="empty-state-submessage">尝试更换关键词或调整筛选条件，或者等待更多新闻被收集</p>
        <a href="{{ url_for('index') }}" class="empty-state-action">返回首页</a>
    </div>
    {% endif %}
    
    <!-- 分页 -->
    {% if total_pages > 1 and view_mode == 'list' %}
    <nav class="pagination-container" aria-label="分页导航">
        <ul class="pagination">
            {% if has_prev %}
            <li>
                <a href="{{ url_for('index', page=page-1, per_page=per_page, keyword=keyword, days=days, source=source, sentiment=sentiment, view=view_mode) }}" class="pagination-link" aria-label="上一页">
                    <i class="icon-arrow-left" aria-hidden="true"></i> 上一页
                </a>
            </li>
            {% else %}
            <li>
                <span class="pagination-link disabled" aria-disabled="true" aria-label="上一页">
                    <i class="icon-arrow-left" aria-hidden="true"></i> 上一页
                </span>
            </li>
            {% endif %}
            
            {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
            <li>
                <a href="{{ url_for('index', page=p, per_page=per_page, keyword=keyword, days=days, source=source, sentiment=sentiment, view=view_mode) }}" 
                   class="pagination-link {% if p == page %}active{% endif %}"
                   aria-label="第 {{ p }} 页"
                   {% if p == page %}aria-current="page"{% endif %}>
                    {{ p }}
                </a>
            </li>
            {% endfor %}
            
            {% if has_next %}
            <li>
                <a href="{{ url_for('index', page=page+1, per_page=per_page, keyword=keyword, days=days, source=source, sentiment=sentiment, view=view_mode) }}" class="pagination-link" aria-label="下一页">
                    下一页 <i class="icon-arrow-right" aria-hidden="true"></i>
                </a>
            </li>
            {% else %}
            <li>
                <span class="pagination-link disabled" aria-disabled="true" aria-label="下一页">
                    下一页 <i class="icon-arrow-right" aria-hidden="true"></i>
                </span>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</section>

<!-- 右侧热门关键词和数据统计 -->
<aside class="sidebar" aria-label="侧边栏">
    <!-- 热门关键词 -->
    <div class="keywords-section">
        <h2 class="section-title" id="hot-keywords-heading"><i class="icon-keyword" aria-hidden="true"></i> 热门关键词</h2>
        
        <!-- 分类标签 -->
        <div class="category-tabs">
            {% for category in categorized_keywords.keys() %}
            <button class="category-tab {% if loop.first %}active{% endif %}" data-category="{{ category }}">{{ category }}</button>
            {% endfor %}
        </div>
        
        <!-- 关键词内容 -->
        {% for category, keywords in categorized_keywords.items() %}
        <div class="keywords-grid category-content" id="category-{{ category }}" {% if not loop.first %}style="display: none;"{% endif %}>
            {% for item in keywords %}
            <a href="{{ url_for('index', keyword=item.keyword) }}" class="keyword-tag" data-count="{{ item.count }}">
                {{ item.keyword }}
                <span class="keyword-count">{{ item.count }}</span>
            </a>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    
    <!-- 数据统计 -->
    <div class="stats-section">
        <h2 class="section-title" id="stats-heading"><i class="icon-sentiment" aria-hidden="true"></i> 数据统计</h2>
        <div class="stats-content" aria-labelledby="stats-heading">
            <div class="stats-item">
                <div class="stats-label">今日新闻</div>
                <div class="stats-value">{{ today_count }}</div>
                <div class="stats-chart">
                    <div class="chart-bar" style="height: {{ (today_count / (total_count or 1)) * 100 }}%"></div>
                </div>
            </div>
            <div class="stats-item">
                <div class="stats-label">总新闻量</div>
                <div class="stats-value">{{ total_count }}</div>
                <div class="stats-chart">
                    <div class="chart-bar" style="height: 100%"></div>
                </div>
            </div>
            <div class="stats-item">
                <div class="stats-label">来源数量</div>
                <div class="stats-value">{{ sources|length }}</div>
                <div class="stats-chart">
                    <div class="chart-bar" style="height: {{ (sources|length / 10) * 100 }}%"></div>
                </div>
            </div>
        </div>
        
        <div class="stats-sentiment">
            <h3 class="stats-subtitle">情感分布</h3>
            <div class="sentiment-chart">
                <div class="sentiment-bar positive" style="width: {{ (positive_count / (total_count or 1)) * 100 }}%" title="积极: {{ positive_count }}条"></div>
                <div class="sentiment-bar neutral" style="width: {{ (neutral_count / (total_count or 1)) * 100 }}%" title="中性: {{ neutral_count }}条"></div>
                <div class="sentiment-bar negative" style="width: {{ (negative_count / (total_count or 1)) * 100 }}%" title="消极: {{ negative_count }}条"></div>
            </div>
            <div class="sentiment-legend">
                <span class="legend-item"><span class="legend-color positive"></span>积极 ({{ positive_count }})</span>
                <span class="legend-item"><span class="legend-color neutral"></span>中性 ({{ neutral_count }})</span>
                <span class="legend-item"><span class="legend-color negative"></span>消极 ({{ negative_count }})</span>
            </div>
        </div>
        
        <div class="stats-trend">
            <h3 class="stats-subtitle">近期趋势</h3>
            <div class="trend-chart">
                {% for item in date_counts %}
                <div class="trend-bar-container" title="{{ item.date }}: {{ item.count }}条新闻">
                    <div class="trend-bar" style="height: {{ (item.count / (date_counts|map(attribute='count')|max or 1)) * 100 }}%"></div>
                    <div class="trend-date">{{ item.date[-5:] }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</aside>
{% endblock %}

{% block extra_js %}
<script>
    // 添加键盘导航支持
    document.addEventListener('DOMContentLoaded', function() {
        // 为筛选条件折叠/展开按钮添加键盘支持
        const filterToggle = document.querySelector('.filter-toggle');
        if (filterToggle) {
            filterToggle.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        }
        
        // 为筛选选项添加键盘支持
        const filterOptions = document.querySelectorAll('.filter-option');
        filterOptions.forEach(option => {
            option.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
        
        // 关键词分类标签切换
        const categoryTabs = document.querySelectorAll('.category-tab');
        const categoryContents = document.querySelectorAll('.category-content');
        
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // 移除所有标签的活跃状态
                categoryTabs.forEach(t => t.classList.remove('active'));
                
                // 隐藏所有内容
                categoryContents.forEach(content => {
                    content.style.display = 'none';
                });
                
                // 激活当前标签
                this.classList.add('active');
                
                // 显示对应内容
                const category = this.getAttribute('data-category');
                const targetContent = document.getElementById('category-' + category);
                if (targetContent) {
                    targetContent.style.display = 'grid';
                }
            });
            
            // 添加键盘支持
            tab.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
        
        // 修复可能的乱码问题
        function fixEncoding() {
            // 修复时间显示
            document.querySelectorAll('.news-time').forEach(el => {
                const text = el.textContent.trim();
                if (text.includes('æ') || text.includes('ç') || text.includes('¥')) {
                    el.innerHTML = '<i class="icon-time" aria-hidden="true"></i> ' + formatDate(text);
                }
            });
            
            // 修复内容显示
            document.querySelectorAll('.news-summary').forEach(el => {
                const text = el.textContent.trim();
                if (text.includes('æ') || text.includes('ç') || text.includes('¥')) {
                    el.textContent = '内容解析中...';
                }
            });
        }
        
        // 简单的日期格式化函数
        function formatDate(dateStr) {
            // 尝试从乱码中提取有效日期
            if (dateStr.includes('月') && dateStr.includes('日')) {
                return dateStr; // 已经是中文格式
            }
            
            // 如果是数字格式，尝试格式化
            const match = dateStr.match(/(\d{1,2})[\-\/](\d{1,2})/);
            if (match) {
                return match[1] + '月' + match[2] + '日';
            }
            
            // 如果无法解析，返回默认值
            return '最近更新';
        }
        
        // 执行修复
        fixEncoding();
    });
</script>
{% endblock %} 